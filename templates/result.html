<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analysis Dashboard | ClearCredit XAI</title>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <div class="stars"></div>

    <nav style="position: relative; background: transparent; backdrop-filter: none;">
        <div class="brand"><i class="fas fa-circle-info"
                style="color: var(--color-primary);"></i>Clear<span>Credit</span> XAI</div>
        <div class="nav-actions">
            <a href="/" class="btn-nav outline">New Calculation</a>
        </div>
    </nav>

    <div class="app-container" style="padding: 2rem 4rem;">

        <div class="dashboard-grid">

            <!-- Result Overview -->
            <div class="glass-card col-12 result-card">
                <span class="subtitle"
                    style="color: var(--color-primary); font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">The
                    Verdict</span>
                <div class="risk-value {{ result }}">{{ result }} Risk</div>
                <div
                    style="display: flex; justify-content: center; gap: 4rem; margin-top: 2rem; border-top: 1px solid var(--color-glass-border); padding-top: 2rem;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--color-text-muted); text-transform: uppercase;">
                            Default Probability</div>
                        <div style="font-size: 2rem; font-weight: 800;">{{ probability }}%</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--color-text-muted); text-transform: uppercase;">Trust
                            Score</div>
                        <div style="font-size: 2rem; font-weight: 800; color: var(--color-risk-low);">98.4</div>
                    </div>
                </div>
            </div>

            <!-- AI Drivers (LIME) -->
            <div class="glass-card col-8">
                <h3 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-lightbulb" style="color: var(--color-primary);"></i> What's driving the decision?
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    {% for item in top_reasons %}
                    <div class="driver-card {{ 'increase' if item.impact == 'Negative' else 'decrease' }}">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <span
                                style="font-size: 0.7rem; font-weight: 800; text-transform: uppercase; opacity: 0.5;">{{
                                item.factor }}</span>
                            <i class="fas {{ item.icon }}" style="font-size: 1rem;"></i>
                        </div>
                        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;">{{ item.condition }}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--color-text-muted); line-height: 1.4;">{{
                            item.recommendation }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Risk Gauge -->
            <div class="glass-card col-4"
                style="text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <h3 style="margin-bottom: 2rem;">Risk Level</h3>
                <div style="position: relative; height: 250px; width: 100%;">
                    <canvas id="riskGauge"></canvas>
                    <div style="position: absolute; top: 50%; left: 0; right: 0; transform: translateY(-50%);">
                        <div style="font-size: 3rem; font-weight: 800;">{{ probability }}</div>
                        <div style="font-size: 0.7rem; color: var(--color-text-muted); text-transform: uppercase;">Score
                        </div>
                    </div>
                </div>
            </div>

            <!-- What-If Simulator -->
            <div class="glass-card col-8">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem;">
                    <h3>Alternative <span>Realities</span></h3>
                    <button onclick="resetSimulator()" class="btn-nav outline" style="font-size: 0.7rem;">Reset
                        Params</button>
                </div>

                <div class="simulator-controls">
                    <div>
                        <div style="display: flex; justify-content: space-between;">
                            <label style="font-size: 0.8rem; font-weight: 700; color: var(--color-text-muted);">LOAN
                                AMOUNT ($)</label>
                            <span id="loan_val_display"
                                style="font-family: 'Outfit'; font-weight: 800; color: var(--color-primary);">$0</span>
                        </div>
                        <input type="range" id="sim_loan_amnt" min="1000" max="250000" step="1000"
                            value="{{ original_data.loan_amnt }}">
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between;">
                            <label style="font-size: 0.8rem; font-weight: 700; color: var(--color-text-muted);">INTEREST
                                RATE (%)</label>
                            <span id="rate_val_display"
                                style="font-family: 'Outfit'; font-weight: 800; color: var(--color-primary);">0%</span>
                        </div>
                        <input type="range" id="sim_loan_int_rate" min="1" max="30" step="0.5"
                            value="{{ original_data.loan_int_rate }}">
                    </div>
                </div>

                <div id="sim_feedback"
                    style="margin-top: 3rem; padding: 1.5rem; background: rgba(255,255,255,0.02); border-radius: var(--radius-md); border-left: 2px solid var(--color-primary); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> <span id="sim_advice">Shifting variables to redraw the risk
                        landscape...</span>
                </div>
            </div>

            <!-- Financial Health -->
            <div class="glass-card col-4">
                <h3 style="margin-bottom: 2rem;">Financial Health</h3>
                <div style="margin-bottom: 3rem;">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.75rem;">
                        <span>DTI RATIO</span>
                        <span id="dti_value">0%</span>
                    </div>
                    <div
                        style="height: 4px; background: var(--color-glass-border); border-radius: 2px; overflow: hidden;">
                        <div id="dti_bar"
                            style="height: 100%; background: var(--color-primary); width: 0%; transition: 0.6s;"></div>
                    </div>
                </div>

                <div
                    style="background: rgba(255,255,255,0.03); padding: 2rem; border-radius: var(--radius-md); text-align: center;">
                    <div
                        style="font-size: 0.7rem; color: var(--color-text-muted); text-transform: uppercase; margin-bottom: 0.5rem;">
                        Estimated Safety Ceiling</div>
                    <div id="max_loan_val" style="font-size: 2rem; font-weight: 800; color: var(--color-risk-low);">$0
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="data-store" data-original='{{ original_data | tojson | safe }}' data-stats='{{ db_stats | tojson | safe }}'
        data-prob='{{ probability }}'></div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const store = document.getElementById('data-store');
        const originalData = JSON.parse(store.dataset.original);
        const dbStats = JSON.parse(store.dataset.stats);
        const probOrig = Number(store.dataset.prob);

        const ctxGauge = document.getElementById('riskGauge').getContext('2d');

        let gaugeColor = probOrig > 50 ? '#ff3e3e' : '#00ff88';

        const riskGaugeChart = new Chart(ctxGauge, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [probOrig, 100 - probOrig],
                    backgroundColor: [gaugeColor, 'rgba(255,255,255,0.05)'],
                    borderWidth: 0,
                    borderRadius: 20,
                    cutout: '85%',
                    rotation: 225,
                    circumference: 270
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });

        // Simulator Logic
        const loanRange = document.getElementById('sim_loan_amnt');
        const rateRange = document.getElementById('sim_loan_int_rate');
        const loanDisplay = document.getElementById('loan_val_display');
        const rateDisplay = document.getElementById('rate_val_display');

        const updateSimUI = (data) => {
            riskGaugeChart.data.datasets[0].data = [data.probability, 100 - data.probability];
            riskGaugeChart.data.datasets[0].backgroundColor[0] = data.probability > 50 ? '#ff3e3e' : '#00ff88';
            riskGaugeChart.update();

            const advice = document.getElementById('sim_advice');
            if (data.result === 'High') {
                advice.innerText = "These values make the loan high risk. The model thinks a default is likely.";
                document.getElementById('sim_feedback').style.borderLeftColor = '#ff3e3e';
            } else {
                advice.innerText = "These values look safe. The model predicts a low risk of default.";
                document.getElementById('sim_feedback').style.borderLeftColor = '#00ff88';
            }
        };

        const runSimulation = async () => {
            loanDisplay.innerText = "$" + Number(loanRange.value).toLocaleString();
            rateDisplay.innerText = rateRange.value + "%";

            const updated = { ...originalData };
            updated.loan_amnt = loanRange.value;
            updated.loan_int_rate = rateRange.value;
            updated.loan_percent_income = (Number(updated.loan_amnt) / Number(updated.person_income)).toFixed(2);

            try {
                const res = await fetch('/predict_api', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updated)
                });
                const data = await res.json();
                updateSimUI(data);
                calculateFinancials();
            } catch (e) { }
        };

        const calculateFinancials = () => {
            const loan = Number(loanRange.value);
            const income = originalData.person_income / 12;
            const rate = Number(rateRange.value) / 100 / 12;
            const emi = loan * rate * Math.pow(1 + rate, 60) / (Math.pow(1 + rate, 60) - 1);
            const dti = (emi / income) * 100;

            document.getElementById('dti_value').innerText = dti.toFixed(1) + "%";
            document.getElementById('dti_bar').style.width = Math.min(dti, 100) + "%";

            const maxLoan = (originalData.person_income / 12) * (dbStats.p75_lti_approved || 0.20) * 12;
            document.getElementById('max_loan_val').innerText = "$" + Math.floor(maxLoan).toLocaleString();
        };

        const resetSimulator = () => {
            loanRange.value = originalData.loan_amnt;
            rateRange.value = originalData.loan_int_rate;
            runSimulation();
        };

        loanRange.addEventListener('input', runSimulation);
        rateRange.addEventListener('input', runSimulation);

        runSimulation();
    </script>
</body>

</html>